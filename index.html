<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no, maximum-scale=1" />
<title>Malta Information App — v7.0-O (Starter)</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
  :root{
    --bg0:#0B0D12; --bg1:#141722; --surface:#181A24; --stroke:rgba(255,255,255,.16);
    --text:#EEF3FF; --muted:rgba(238,243,255,.70); --blue:#0A84FF;
    --green:#32D74B; --red:#FF453A;
    --radius-card:18px; --radius-hero:18px; --dock-h:0px;
    --title-size:22px; --h2-size:18px; --body-size:16px; --label-size:14px;
    --shadow-card:0 12px 34px rgba(0,0,0,.45); --shadow-dock:0 2px 6px rgba(0,0,0,.25);
  }
  html, body{
    margin:0; padding:0; height:100%;
    background:linear-gradient(180deg, var(--bg0), var(--bg1));
    color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    -webkit-text-size-adjust:100%;
    overflow:hidden;
  }
  #viewport{ position:fixed; inset:0; padding-top:var(--dock-h); overflow:auto;
    overscroll-behavior:none; -webkit-overflow-scrolling:touch; }
  a,button{ -webkit-tap-highlight-color:transparent; }
  button{ font:inherit; color:inherit; border:none; background:none; cursor:pointer; }
  .visually-hidden{ position:absolute!important; clip:rect(1px,1px,1px,1px); width:1px; height:1px; overflow:hidden; }

  /* GRID */
  #home{ padding:20px 16px calc(20px + env(safe-area-inset-bottom)); max-width:1200px; margin:0 auto; display:block; }
  .grid{ display:grid; grid-template-columns:repeat(5,1fr); gap:16px; }
  @media (max-width:1023px){ .grid{ grid-template-columns:repeat(4,1fr);} }
  @media (max-width:767px){ .grid{ grid-template-columns:repeat(3,1fr);} }
  @media (max-width:599px){ .grid{ grid-template-columns:repeat(2,1fr);} }
  @media (max-width:479px){ .grid{ grid-template-columns:repeat(1,1fr);} }
  .card{ list-style:none; user-select:none; position:relative; }
  .cardBtn{ display:block; text-align:center; color:inherit; text-decoration:none; }
  .cardImg{ aspect-ratio:16/10; background:var(--surface); border-radius:var(--radius-card);
    box-shadow:var(--shadow-card); border:1px solid var(--stroke);
    display:flex; align-items:center; justify-content:center; font-weight:600; font-size:14px; color:var(--muted); position:relative; }
  .cardTitle{ margin-top:8px; font-weight:600; font-size:14px; text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .playDot{ position:absolute; top:8px; right:12px; width:8px; height:8px; border-radius:50%; background:var(--blue); z-index:3; display:none; }
  .card.playing .playDot{ display:block; background:var(--green); }
  .card.paused  .playDot{ display:block; background:var(--red); }

  .readChk{ position:absolute; left:10px; top:10px; width:24px; height:24px; border-radius:8px; border:1px solid var(--stroke);
    background:rgba(255,255,255,.04); display:flex; align-items:center; justify-content:center; }
  .readChk[aria-checked="true"]::after{ content:"✓"; font-weight:700; }
  .readBadge{ position:absolute; right:8px; bottom:8px; width:22px; height:22px; border-radius:50%; background:rgba(255,255,255,.08);
    border:1px solid var(--stroke); display:none; align-items:center; justify-content:center; font-size:14px; color:var(--text); }
  .card.read .readBadge{ display:flex; }
  .card.read .readBadge::after{ content:"✓"; }

  /* READER */
  #reader{ display:none; padding:0 16px calc(24px + env(safe-area-inset-bottom)); max-width:900px; margin:0 auto; }
  .reader-header{ position:sticky; top:0; z-index:2; padding:calc(6px + env(safe-area-inset-top)) 0 10px;
    background:linear-gradient(180deg, rgba(20,22,34,.95), rgba(20,22,34,0)); backdrop-filter:blur(6px);
    box-shadow:0 2px 6px rgba(0,0,0,.25); }
  .reader-head-row{ display:flex; align-items:center; gap:12px; }
  .btn-back{ min-width:44px; min-height:44px; padding:8px 12px; border-radius:10px; border:1px solid var(--stroke); background:rgba(255,255,255,.04); }
  .reader-title{ font-weight:600; font-size:var(--title-size); margin:0; flex:1; text-align:center; }
  .reader-hero{ margin-top:12px; width:100%; aspect-ratio:16/10; border-radius:var(--radius-hero);
    background:linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); border:1px solid var(--stroke); box-shadow:var(--shadow-card); }
  .section{ margin-top:16px; }
  .section .heading{ display:flex; align-items:center; gap:8px; margin:20px 0; }
  .section h2{ font-size:var(--h2-size); margin:12px 0; }
  .readBtn{ margin-left:auto; border:1px solid var(--stroke); border-radius:10px; padding:8px 12px; min-height:44px; min-width:44px; }
  .readToggle{ display:flex; align-items:center; gap:8px; margin-left:8px; }
  .readToggle button{ min-width:44px; min-height:44px; border-radius:10px; border:1px solid var(--stroke); background:rgba(255,255,255,.04); padding:8px 12px; }

  .body{ font-size:var(--body-size); line-height:1.7; user-select:none; }
  .body .subhead{ display:block; font-weight:700; font-size:calc(var(--h2-size) + 1px); margin:28px 0 10px; line-height:1.5; color:var(--text); }
  .body .para{ display:block; margin:0 0 18px; color:var(--muted); }
  .body .w{ display:inline-block; position:relative; padding-bottom:6px; }
  .body .w .comet{
    position:absolute; left:0; bottom:0; width:var(--comet-w,16px); height:3px; border-radius:3px;
    background:linear-gradient(to right, rgba(10,132,255,0) 0%, rgba(10,132,255,.25) 45%, rgba(10,132,255,.7) 85%, rgba(10,132,255,1) 100%);
    box-shadow:0 0 10px rgba(10,132,255,.55); transform:translateX(0); opacity:0; transition:opacity .12s linear; will-change:transform,opacity;
  }
  .body .w.active .comet{ opacity:1; }

  /* Word popover */
  .popover{ position:fixed; z-index:30; min-width:220px; background:var(--surface); border:1px solid var(--stroke);
    border-radius:12px; box-shadow:0 10px 28px rgba(0,0,0,.5); padding:6px; }
  .popover[hidden]{ display:none; }
  .popover .row{ display:flex; gap:8px; }
  .popover .row button{ flex:1; padding:10px 12px; border-radius:10px; border:1px solid var(--stroke); background:rgba(255,255,255,.04); }

  /* Dock (mini-player) */
  #dock{ position:fixed; top:0; left:0; right:0; z-index:100; background:var(--surface);
    border-bottom:1px solid var(--stroke); box-shadow:var(--shadow-dock); padding-top:calc(env(safe-area-inset-top)); display:none; }
  #dockRow{ height:56px; display:flex; align-items:center; gap:8px; padding:0 8px; }
  .dockBtn{ min-width:44px; min-height:44px; border-radius:10px; border:1px solid var(--stroke); background:rgba(255,255,255,.04); }
  .dockTitle{ flex:1; position:relative; overflow:hidden; }
  .dockTitle .marquee{ display:inline-block; white-space:nowrap; will-change:transform; }
  .dockTitle .marquee span{ padding:0 24px; display:inline-block; font-weight:600; font-size:var(--label-size); }
  .dockTitle .marquee.scroll{ animation:marquee 12s linear infinite; }
  @keyframes marquee{ 0%{ transform:translateX(0);} 100%{ transform:translateX(-50%);} }
  #dockProgress{ position:absolute; left:0; right:0; bottom:0; height:2px; background:rgba(255,255,255,.08); }
  #dockProgress>i{ display:block; height:100%; width:0%; background:var(--blue); transition:width .08s linear; }
  .menu{ position:absolute; right:8px; top:calc(56px + env(safe-area-inset-top)); z-index:110; background:var(--surface);
    border:1px solid var(--stroke); border-radius:12px; box-shadow:0 10px 28px rgba(0,0,0,.5); padding:6px; width:260px; display:none; }
  .menu.open{ display:block; }
  .menu h4{ font-size:14px; margin:6px 8px; color:var(--muted); }
  .menu .row{ display:flex; gap:8px; padding:6px; }
  .menu .row button{ flex:1; padding:10px; border-radius:10px; border:1px solid var(--stroke); background:rgba(255,255,255,.04); }
  .queueList{ max-height:220px; overflow:auto; margin:6px; border-top:1px solid var(--stroke); padding-top:6px; }
  .queueItem{ display:flex; align-items:center; gap:8px; padding:8px; border-radius:10px; }
  .queueMeta{ flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:13px; color:var(--muted); }

  :focus-visible{ outline:2px solid var(--blue); outline-offset:2px; border-radius:10px; }
  img{ pointer-events:none; -webkit-user-drag:none; }
  .body, .body *{ -webkit-touch-callout:none; -webkit-user-select:none; user-select:none; }
</style>
</head>
<body>
  <!-- Dock -->
  <section id="dock" role="region" aria-label="Mini Player" aria-live="polite">
    <div id="dockRow">
      <button id="btnPrev" class="dockBtn" aria-label="Previous (skip back)">&laquo;</button>
      <button id="btnPlay" class="dockBtn" aria-label="Play" aria-pressed="false">▶︎</button>
      <button id="btnNext" class="dockBtn" aria-label="Next (skip forward)">&raquo;</button>
      <div id="dockTitle" class="dockTitle" role="button" aria-label="Jump to current word">
        <div class="marquee" id="dockMarquee"><span id="dockText">Chapter — Title</span><span id="dockTextClone">Chapter — Title</span></div>
      </div>
      <button id="btnMore" class="dockBtn" aria-label="More menu">⋯</button>
      <button id="btnClose" class="dockBtn" aria-label="Close player">✕</button>
    </div>
    <div id="dockProgress" role="progressbar" aria-label="Reading progress" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"><i></i></div>
    <div id="dockMenu" class="menu" role="menu" aria-label="Player options">
      <h4>Options</h4>
      <div class="row">
        <button id="seekBack" role="menuitem">Seek -10w</button>
        <button id="seekFwd" role="menuitem">Seek +10w</button>
      </div>
      <div class="row">
        <button id="toggleFollow" role="menuitemcheckbox" aria-checked="true">Follow: On</button>
        <button id="clearQueue" role="menuitem">Clear Queue</button>
      </div>
      <h4>Up Next</h4>
      <div class="queueList" id="queueList"></div>
    </div>
  </section>

  <div id="viewport">
    <!-- HOME -->
    <main id="home" role="region" aria-label="Chapters">
      <h1 class="visually-hidden">Malta Information — Chapters</h1>
      <ol class="grid" id="grid" aria-label="Chapter grid"></ol>
    </main>

    <!-- READER -->
    <main id="reader" aria-live="polite">
      <header class="reader-header" role="banner">
        <div class="reader-head-row">
          <button class="btn-back" id="btnBack" aria-label="Back to grid">Back</button>
          <h1 class="reader-title" id="chapterTitle">Chapter — Title</h1>
          <span style="width:44px;"></span>
        </div>
      </header>

      <div class="reader-hero" id="readerHero" aria-hidden="true"></div>

      <section class="section" data-sec="overview">
        <div class="heading">
          <h2>Overview</h2>
          <button id="btnReadOverview" class="readBtn" aria-label="Read Overview from start">🎧</button>
          <div class="readToggle">
            <button id="btnReadToggle" aria-checked="false" aria-label="Mark chapter as read">Read ✓</button>
          </div>
        </div>
        <div class="body" id="sec-overview" aria-label="Overview text"></div>
      </section>
    </main>
  </div>

  <!-- Long-press Popover -->
  <div id="popover" class="popover" role="menu" hidden>
    <div class="row">
      <button class="pop" id="popRead" role="menuitem">Read from here</button>
      <button class="pop" id="popQueue" role="menuitem">Play next from here</button>
    </div>
  </div>

  <!-- ====== PASTE / EDIT YOUR CHAPTERS BELOW ====== -->
  <div id="chapters-data" hidden>
    <!-- Demo chapter -->
    <section class="chapter" data-id="0">
      <h3>History</h3>
      <p>Malta’s history spans millennia, beginning with awe-inspiring prehistoric temples that rank among the oldest free-standing structures in the world. It then served as a strategic crossroads under Phoenician and Roman influence, leaving behind traces in ancient settlements and religious traditions. The arrival of the Knights of St. John ushered in a grand era of fortifications, art, and the founding of Valletta, defining much of the island’s character. French and British rule followed, each leaving their mark through reform and colonial infrastructure, before Malta achieved independence and emerged as a modern European republic.</p>

      <h2>Prehistoric Temples</h2>
      <p>Malta’s most iconic ancient legacy lies in its megalithic temples—Ġgantija, Ħaġar Qim, Mnajdra, Tarxien, Ta’ Ħaġrat, Skorba, and more—which span a timeline from roughly 3600 BC to 2500 BC…</p>

      <h2>Phoenician & Roman Malta</h2>
      <p>After the decline of Malta’s temple-building civilization around 2500 BC…</p>

      <h2>The Knights of St John</h2>
      <p>The arrival of the Knights of St John in 1530 marked a transformative chapter…</p>

      <h2>French & British Rule</h2>
      <p>Napoleon’s arrival in 1798 abruptly ended 268 years of Hospitaller rule…</p>

      <h2>Independence & Modern Era</h2>
      <p>After centuries of foreign rule, Malta gained independence on 21 September 1964…</p>
    </section>

    <!-- Your chapter -->
    <section class="chapter" data-id="1">
      <h3>General Life in Malta</h3>
      <p>Life in Malta reflects its Mediterranean rhythm: mornings begin with seaside walks and fresh Hobż biż-żejt, afternoons slow during the midday heat, and evenings are for dining outdoors, music, or strolls through historic streets. Family and community form the core of society, with Catholic traditions and lively festas uniting generations in shared identity, supported by strong social networks. Work balances modern opportunities with leisure, as low unemployment, growing sectors, and a vibrant cultural scene coexist with an easy pace of life. Malta’s international character, shaped by centuries of global influences and an active expat community, blends heritage with cosmopolitan flair in its food, wine, and arts. Challenges remain—congested roads, high housing costs, and bureaucratic delays—but the island’s safety, solid healthcare and education, and enduring authenticity make it both welcoming and resilient.</p>

      <h2>Daily Routines</h2>
      <p>In Malta, daily life is shaped deeply by its bright Mediterranean climate…</p>

      <h2>Family & Community</h2>
      <p>Malta thrives on close-knit family ties and tightly bonded neighbourhoods…</p>

      <h2>Work & Leisure</h2>
      <p>Working in Malta offers a unique work–life balance…</p>

      <h2>International Identity</h2>
      <p>Global influences have long shaped Maltese life…</p>

      <h2>Modern Challenges</h2>
      <p>Even as Malta charms, it grapples with contemporary growing pains…</p>
    </section>
  </div>

  <!-- APP SCRIPT -->
  <script>
  (() => {
    "use strict";

    /* Utilities */
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const escapeHtml = s => s.replace(/[&<>\"']/g, m =>
      ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

    /* Storage */
    const store = {
      get(k, d){ try{ return JSON.parse(localStorage.getItem(k)) ?? d; }catch{ return d; } },
      set(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} }
    };

    /* State */
    const STATE = {
      chapters: [],
      player: store.get("mia.player", {chapterIndex:0, wordIndex:0, playing:false, follow:true, withinWord:0}),
      queue: store.get("mia.queue", []),
      readState: store.get("mia.read", {}),
      voice: null, voices: [], reduced: matchMedia('(prefers-reduced-motion: reduce)').matches,
      currentUtterance:null, currentChunk:null,
      displayedChapter:null
    };

    /* DOM */
    const homeEl=$("#home"), gridEl=$("#grid"), readerEl=$("#reader"), viewportEl=$("#viewport");
    const chapterTitleEl=$("#chapterTitle"), secOverviewEl=$("#sec-overview"), heroEl=$("#readerHero");
    const btnBack=$("#btnBack"), btnReadOverview=$("#btnReadOverview"), btnReadToggle=$("#btnReadToggle");
    const dockEl=$("#dock"), dockBar=$("#dockProgress>i"), dockBarEl=$("#dockProgress");
    const btnPrev=$("#btnPrev"), btnPlay=$("#btnPlay"), btnNext=$("#btnNext"), btnMore=$("#btnMore"), btnClose=$("#btnClose");
    const menuEl=$("#dockMenu"), seekBackBtn=$("#seekBack"), seekFwdBtn=$("#seekFwd"),
          toggleFollowBtn=$("#toggleFollow"), clearQueueBtn=$("#clearQueue"), queueList=$("#queueList");
    const popEl=$("#popover"), popRead=$("#popRead"), popQueue=$("#popQueue");
    const dockTitleEl=$("#dockTitle"), dockMarquee=$("#dockMarquee"), dockText=$("#dockText"), dockTextClone=$("#dockTextClone");

    /* Parse authored chapters (HTML or RAW) */
    function parseRawToHtml(raw){
      const lines = raw.split(/\r?\n/);
      const out = []; let para=[];
      const isHeading = line => /^#{1,3}\s/.test(line) || /^[0-9]+[.)]\s/.test(line) ||
        (/^[A-Z][A-Za-z0-9 ,:'&\-]+$/.test(line.trim()) && line.trim().length<=72);
      const flushPara = () => { if(para.length){ out.push(`<p>${escapeHtml(para.join(" ").trim())}</p>`); para=[]; } };
      for(const line of lines){
        if(!line.trim()){ flushPara(); continue; }
        if(isHeading(line)){
          flushPara();
          out.push(`<h3>${escapeHtml(line.replace(/^#{1,3}\s/,"").replace(/^[0-9]+[.)]\s/,"").trim())}</h3>`);
        }else{
          para.push(line.trim());
        }
      }
      flushPara(); return out.join("\n");
    }

    function buildChaptersFromAuthored(){
      const sections = $$("#chapters-data > section.chapter");
      return sections.map((sec, i) => {
        const id = Number(sec.dataset.id||i);
        let html = "";
        const raw = sec.querySelector("script.raw, script[type='text/plain'].raw");
        if(raw){ html = parseRawToHtml(raw.textContent||""); }
        else {
          const tmp = [];
          sec.querySelectorAll("h1,h2,h3,h4,h5,p").forEach(el => {
            const tag = el.tagName.toLowerCase();
            if (tag === "p") tmp.push(`<p>${escapeHtml(el.textContent || "")}</p>`);
            else tmp.push(`<h3>${escapeHtml(el.textContent || "")}</h3>`);
          });
          html = tmp.join("\n");
        }
        const title = (sec.querySelector("h1,h2,h3")?.textContent?.trim()) || `Chapter ${String(id+1).padStart(2,"0")}`;
        return { id, title, html };
      }).sort((a,b)=>a.id-b.id);
    }

    function wrapWords(html){
      const container = document.createElement("div");
      container.innerHTML = html;
      let index=0;
      container.querySelectorAll("h3,p").forEach(el => {
        const words = (el.textContent||"").trim().split(/\s+/).filter(Boolean);
        const cls  = el.tagName.toLowerCase()==="h3" ? "subhead" : "para";
        const span = document.createElement("span");
        span.className = cls;
        span.innerHTML = words.map(w=>`<span class="w" data-index="${index++}">${escapeHtml(w)}<i class="comet" aria-hidden="true"></i></span>`).join(" ");
        el.replaceWith(span);
      });
      return { html: container.innerHTML, total:index };
    }

    /* Grid */
    function renderGrid(){
      gridEl.innerHTML="";
      STATE.chapters.forEach((ch,idx)=>{
        const li=document.createElement("li"); li.className="card"; li.dataset.index=idx;
        const dot=document.createElement("i"); dot.className="playDot"; dot.setAttribute("aria-hidden","true");
        const chk=document.createElement("button"); chk.className="readChk"; chk.setAttribute("aria-label",`Mark ${ch.title} as read`);
        chk.setAttribute("aria-checked", STATE.readState[idx] ? "true":"false");
        chk.addEventListener("click",(e)=>{ e.stopPropagation(); e.preventDefault(); toggleRead(idx, !STATE.readState[idx]); });
        li.appendChild(chk);

        const badge=document.createElement("div"); badge.className="readBadge"; badge.setAttribute("aria-hidden","true");
        const a=document.createElement("a"); a.href="#"; a.className="cardBtn"; a.setAttribute("role","button"); a.setAttribute("aria-label",`Open ${ch.title}`);
        a.addEventListener("click",(e)=>{ e.preventDefault(); openReader(idx); });
        const img=document.createElement("div"); img.className="cardImg"; img.textContent="Hero";
        img.appendChild(badge); img.appendChild(dot);
        const title=document.createElement("div"); title.className="cardTitle"; title.textContent=ch.title;
        a.appendChild(img); a.appendChild(title); li.appendChild(a); gridEl.appendChild(li);
        if(STATE.readState[idx]) li.classList.add("read");
      });
      renderGridIndicatorState();
    }
    function renderGridIndicatorState(){
      gridEl.querySelectorAll(".card").forEach(n=>{ n.classList.remove("playing","paused"); });
      const dockVisible = (dockEl.style.display!=="none");
      if(!dockVisible) return;
      const activeIdx = STATE.player.chapterIndex;
      const activeCard = gridEl.querySelector(`.card[data-index="${activeIdx}"]`);
      if(!activeCard) return;
      if(STATE.player.playing) activeCard.classList.add("playing");
      else if(STATE.player.wordIndex>0 || STATE.player.withinWord>0) activeCard.classList.add("paused");
    }

    /* Reader */
    function openReader(index){
      STATE.displayedChapter=index;
      const ch=STATE.chapters[index];
      chapterTitleEl.textContent=ch.title;
      heroEl.style.backgroundImage="none";

      const {html, total} = wrapWords(ch.html);
      secOverviewEl.innerHTML = html;

      requestAnimationFrame(()=>{
        secOverviewEl.querySelectorAll(".w").forEach(w=>{
          const px = Math.max(10, Math.min(28, w.offsetWidth * 0.25));
          w.style.setProperty('--comet-w', px + 'px');
        });
      });

      bindDelegatedGestures();
      homeEl.style.display="none"; readerEl.style.display="block"; renderGridIndicatorState();
      viewportEl.scrollTo({top:0, behavior: STATE.reduced ? "auto":"smooth"});
      updateDockTitle();
      updateProgress(STATE.player.wordIndex, total, STATE.player.withinWord||0);
      updateReaderReadToggle(index);
    }
    function backToGrid(){
      STATE.player.follow=false; setFollowUI(false,true);
      stopComet(true);
      readerEl.style.display="none"; homeEl.style.display="block"; renderGridIndicatorState();
      viewportEl.scrollTo({top:0, behavior:"auto"});
    }
    const btnBackEl=$("#btnBack");
    btnBackEl.addEventListener("click", backToGrid);
    btnReadOverview.addEventListener("click", ()=> startPlayback(STATE.displayedChapter||0, 0));
    btnReadToggle.addEventListener("click", ()=> { const idx = STATE.displayedChapter ?? STATE.player.chapterIndex ?? 0; toggleRead(idx, !STATE.readState[idx]); });

    /* Long-press (delegated) */
    let lpTimer=null, lpIndex=null;
    function bindDelegatedGestures(){
      secOverviewEl.onpointerdown = secOverviewEl.onpointermove = secOverviewEl.onpointerup = secOverviewEl.onpointercancel = null;
      let down = {x:0,y:0};
      secOverviewEl.addEventListener("pointerdown", (e)=>{
        const w = e.target.closest(".w"); if(!w) return;
        e.preventDefault();
        down = {x:e.clientX, y:e.clientY};
        lpIndex = Number(w.dataset.index||"0");
        lpTimer = setTimeout(()=> showPopoverAtWord(w), 380);
      }, {passive:false});
      secOverviewEl.addEventListener("pointermove", (e)=>{
        if(!lpTimer) return;
        if(Math.abs(e.clientX-down.x)+Math.abs(e.clientY-down.y) > 10){ clearTimeout(lpTimer); lpTimer=null; }
      }, {passive:false});
      const cancel = ()=>{ if(lpTimer){ clearTimeout(lpTimer); lpTimer=null; } };
      secOverviewEl.addEventListener("pointerup", cancel);
      secOverviewEl.addEventListener("pointercancel", cancel);
      document.addEventListener("pointerdown", (e)=>{ if(!popEl.hidden && !popEl.contains(e.target)) popEl.hidden=true; }, {passive:true});
    }
    function showPopoverAtWord(wordEl){
      const rect=wordEl.getBoundingClientRect(); const pw=240, ph=88; const vw=innerWidth, vh=innerHeight;
      let left=rect.left + rect.width/2 - pw/2; let top = rect.bottom + 8;
      if(left<8) left=8; if(left+pw>vw-8) left=vw-pw-8; if(top+ph>vh-8) top=rect.top-ph-8;
      popEl.style.left=left+"px"; popEl.style.top=top+"px"; popEl.hidden=false; popEl.dataset.wordIndex=String(lpIndex||0);
    }
    popRead.addEventListener("click", ()=>{ const idx=Number(popEl.dataset.wordIndex||"0"); popEl.hidden=true; startPlayback(STATE.displayedChapter||0, idx); });
    popQueue.addEventListener("click", ()=>{ const idx=Number(popEl.dataset.wordIndex||"0"); popEl.hidden=true; addToQueue(STATE.displayedChapter||0, idx); });

    /* Dock + progress */
    function setDockVisible(v){
      dockEl.style.display = v ? "block" : "none";
      document.documentElement.style.setProperty("--dock-h", v ? dockEl.getBoundingClientRect().height + "px" : "0px");
      renderGridIndicatorState();
    }
    function updateDockTitle(){
      const ch = STATE.chapters[STATE.player.chapterIndex];
      const title = ch ? ch.title : "Mini Player";
      dockText.textContent = title; dockTextClone.textContent = " • " + title;
      requestAnimationFrame(()=>{
        const containerW = dockTitleEl.clientWidth;
        const contentW = dockText.scrollWidth;
        if(contentW > containerW) dockMarquee.classList.add("scroll"); else dockMarquee.classList.remove("scroll");
      });
    }
    function updateProgress(wordIndex, total, withinWord){
      const pct = total ? ((wordIndex + (withinWord||0)) / total) * 100 : 0;
      dockBar.style.width = Math.min(100, Math.max(0, pct)) + "%";
      dockBarEl.setAttribute("aria-valuenow", String(Math.round(pct)));
    }
    btnPrev.addEventListener("click", ()=> seekWords(-10));
    btnNext.addEventListener("click", ()=> seekWords(+10));
    btnPlay.addEventListener("click", ()=>{ STATE.player.playing ? pausePlayback() : resumePlayback(); });
    btnClose.addEventListener("click", stopPlayback);
    dockTitleEl.addEventListener("click", ()=>{
      if(readerEl.style.display!=="block") openReader(STATE.player.chapterIndex);
      else if((STATE.displayedChapter ?? -1) !== STATE.player.chapterIndex) openReader(STATE.player.chapterIndex);
      const w = secOverviewEl.querySelector(`.w[data-index="${STATE.player.wordIndex}"]`);
      if(w){ w.scrollIntoView({block:"center", behavior: STATE.reduced ? "auto":"smooth"}); STATE.player.follow=true; setFollowUI(true,true); store.set("mia.player", STATE.player); }
    });
    btnMore.addEventListener("click", ()=>{ menuEl.classList.toggle("open"); renderQueue();
      if(menuEl.classList.contains("open") && STATE.player.follow){ STATE.player.follow=false; setFollowUI(false,true); store.set("mia.player", STATE.player);} });
    document.addEventListener("pointerdown", (e)=>{ if(menuEl.classList.contains("open") && !menuEl.contains(e.target) && e.target!==btnMore){ menuEl.classList.remove("open"); } }, {passive:true});
    seekBackBtn.addEventListener("click", ()=> seekWords(-10));
    seekFwdBtn.addEventListener("click", ()=> seekWords(+10));
    toggleFollowBtn.addEventListener("click", ()=>{ STATE.player.follow=!STATE.player.follow; setFollowUI(STATE.player.follow,true); store.set("mia.player", STATE.player); });
    clearQueueBtn.addEventListener("click", ()=>{ STATE.queue=[]; saveQueue(); });

    function setFollowUI(on, announce){
      toggleFollowBtn.setAttribute("aria-checked", on?"true":"false");
      toggleFollowBtn.textContent="Follow: " + (on?"On":"Off");
      if(announce){ dockEl.setAttribute("aria-live","polite"); dockEl.setAttribute("aria-label", on?"Follow on — following text":"Follow off — browse freely"); }
    }

    function renderQueue(){
      queueList.innerHTML="";
      STATE.queue.forEach((item,idx)=>{
        const row=document.createElement("div"); row.className="queueItem";
        const meta=document.createElement("div"); meta.className="queueMeta"; meta.textContent=item.title+" — word "+(item.wordIndex+1);
        const play=document.createElement("button"); play.textContent="▶︎"; play.setAttribute("aria-label","Play this queued item now");
        play.addEventListener("click", ()=>{ STATE.queue.splice(idx,1); saveQueue(); startPlayback(item.chapterIndex, item.wordIndex); });
        const del=document.createElement("button"); del.textContent="×"; del.setAttribute("aria-label","Remove from queue");
        del.addEventListener("click", ()=>{ STATE.queue.splice(idx,1); saveQueue(); });
        row.appendChild(meta); row.appendChild(play); row.appendChild(del); queueList.appendChild(row);
      });
    }
    function addToQueue(chapterIndex, wordIndex){
      const title = STATE.chapters[chapterIndex] ? STATE.chapters[chapterIndex].title : "Chapter";
      STATE.queue.push({ chapterIndex, wordIndex, title, sectionLabel:"Overview" });
      saveQueue();
    }
    function saveQueue(){ store.set("mia.queue", STATE.queue); renderQueue(); }

    /* Speech + comet */
    let rafId=null, currentWordEl=null, cometEl=null, wordAnimStart=0, wordAnimDur=0, withinWord=0;
    let persistTick=0;
    function ensureVoices(){
      return new Promise(resolve => {
        if(!('speechSynthesis' in window)) return resolve();
        function done(){ const v=speechSynthesis.getVoices()||[]; STATE.voices=v;
          STATE.voice = v.find(x=>x.lang?.startsWith("en-AU")) || v.find(x=>x.lang?.startsWith("en-")) || v[0] || null; resolve(); }
        const got = speechSynthesis.getVoices()||[]; if(got.length) return done();
        window.speechSynthesis.onvoiceschanged = done; setTimeout(done, 120);
      });
    }

    const CHUNK=28;
    function startPlayback(chapterIndex, wordIndex){
      if(!('speechSynthesis' in window)){ alert("Narration not available on this device."); return; }
      cancelSpeech(); stopComet(true);
      STATE.player.chapterIndex=chapterIndex; STATE.player.wordIndex=Math.max(0, wordIndex|0); STATE.player.playing=true; STATE.player.withinWord=0; store.set("mia.player", STATE.player);
      setDockVisible(true); updateDockTitle(); renderGridIndicatorState();
      speakNextChunk(); setPlayUI(true);
    }
    function resumePlayback(){
      if(!('speechSynthesis' in window)){ alert("Narration not available on this device."); return; }
      if(STATE.currentUtterance && speechSynthesis.paused){ try{ speechSynthesis.resume(); }catch{} }
      else if(!speechSynthesis.speaking){ speakNextChunk(); }
      STATE.player.playing=true; store.set("mia.player", STATE.player); setPlayUI(true); renderGridIndicatorState();
    }
    function pausePlayback(){ try{ speechSynthesis.pause(); }catch{} STATE.player.playing=false; store.set("mia.player", STATE.player); setPlayUI(false); stopWordRAF(); renderGridIndicatorState(); }
    function stopPlayback(){ cancelSpeech(); STATE.player.playing=false; store.set("mia.player", STATE.player); setDockVisible(false); setPlayUI(false); stopComet(true); renderGridIndicatorState(); }
    function cancelSpeech(){ try{ speechSynthesis.cancel(); }catch{} STATE.currentUtterance=null; }

    function speakNextChunk(){
      const words = $$("#sec-overview .w").map(w=>w.textContent||"");
      const total=words.length; if(STATE.player.wordIndex>=total){ onChapterFinish(STATE.player.chapterIndex); return; }
      const start=STATE.player.wordIndex; const end=Math.min(total, start+CHUNK);
      STATE.currentChunk = {start, end, boundarySeen:false};
      const u=new SpeechSynthesisUtterance(words.slice(start,end).join(" "));
      if(STATE.voice){ u.voice=STATE.voice; u.lang=STATE.voice.lang; } else { u.lang="en-AU"; }
      u.rate=1.0; u.pitch=1.0;
      let local=0;
      u.onstart = ()=> animateWordAt(start);
      u.onend = ()=>{ STATE.player.wordIndex=end; STATE.player.withinWord=0; store.set("mia.player", STATE.player);
        updateProgress(STATE.player.wordIndex, total, 0); STATE.currentChunk=null; if(STATE.player.playing){ speakNextChunk(); } else { stopWordRAF(); } };
      u.onerror= ()=> stopWordRAF();
      u.onboundary = (ev)=>{ if(ev.name && ev.name.toLowerCase()!=="word") return;
        if(STATE.currentChunk) STATE.currentChunk.boundarySeen=true; const g = start + local; animateWordAt(g); local++; };
      STATE.currentUtterance=u; try{ speechSynthesis.speak(u);}catch{}
    }
    function setPlayUI(playing){ btnPlay.textContent=playing?"❚❚":"▶︎"; btnPlay.setAttribute("aria-pressed", playing?"true":"false"); }

    function stopComet(clear){
      stopWordRAF();
      if(clear && (readerEl.style.display==="block")){
        $$("#sec-overview .w").forEach(w=>{ w.classList.remove("active"); const c=w.querySelector(".comet"); if(c) c.style.transform="translateX(0)"; });
      }
      currentWordEl=null; cometEl=null;
    }
    function stopWordRAF(){ if(rafId){ cancelAnimationFrame(rafId); rafId=null; } withinWord=0; }
    function animateWordAt(index){
      const visible = (readerEl.style.display==="block");
      let w=null, c=null;
      if(currentWordEl) currentWordEl.classList.remove('active');
      if(visible){
        w = $(`#sec-overview .w[data-index="${index}"]`);
        if(w){
          w.classList.add("active");
          c = w.querySelector(".comet");
          if(c){
            const wWidth = w.offsetWidth;
            const cometW = Math.max(10, Math.min(28, wWidth * 0.25));
            w.style.setProperty('--comet-w', cometW + 'px');
          }
        }
      }
      currentWordEl=w; cometEl=c;
      const words = $$("#sec-overview .w");
      const wordText = (words[index] && words[index].textContent) ? words[index].textContent : "";
      const charCount = Math.max(1, wordText.length);
      const base = 30;
      wordAnimDur = Math.max(120, Math.min(1200, base * charCount));
      wordAnimStart = performance.now(); withinWord = 0;
      STATE.player.wordIndex = index; STATE.player.withinWord = 0; store.set("mia.player", STATE.player);
      updateProgress(index, words.length, 0);
      if(visible && STATE.player.follow && w) w.scrollIntoView({block:"center", behavior: STATE.reduced ? "auto":"smooth"});
      runWordRAF();
    }
    function runWordRAF(){
      stopWordRAF();
      const words = $$("#sec-overview .w");
      const total = words.length;
      const step = (ts)=>{
        if(!STATE.player.playing) return;
        const t = Math.min(1, (ts - wordAnimStart)/wordAnimDur);
        const ease = t<0.5 ? 2*t*t : -1+(4-2*t)*t;
        withinWord = ease;
        if(cometEl && currentWordEl){
          const wWidth = currentWordEl.offsetWidth || 0;
          const cometW = parseFloat(getComputedStyle(currentWordEl).getPropertyValue('--comet-w')) || 16;
          const maxX = Math.max(0, wWidth - cometW);
          const x = Math.round(ease * maxX);
          cometEl.style.transform = `translateX(${x}px)`;
        }
        updateProgress(STATE.player.wordIndex, total, ease);
        if((persistTick++ & 3) === 0){ STATE.player.withinWord = ease; store.set("mia.player", STATE.player); }
        const chunk = STATE.currentChunk;
        if(chunk && !chunk.boundarySeen && t>=1){
          const next = STATE.player.wordIndex + 1;
          if(next < chunk.end){ animateWordAt(next); return; }
        }
        rafId = requestAnimationFrame(step);
      };
      rafId = requestAnimationFrame(step);
    }
    function onChapterFinish(finishedIdx){
      toggleRead(finishedIdx, true, true);
      if(STATE.queue.length){ const next=STATE.queue.shift(); saveQueue(); startPlayback(next.chapterIndex, next.wordIndex); }
      else { const n=finishedIdx+1; if(n<STATE.chapters.length) startPlayback(n,0); else stopPlayback(); }
    }
    function seekWords(delta){
      const words = $$("#sec-overview .w");
      const total = words.length;
      let idx = STATE.player.wordIndex + delta;
      if(idx<0) idx=0; if(idx>=total) idx=total-1;
      STATE.player.wordIndex=idx; STATE.player.withinWord=0; store.set("mia.player", STATE.player); updateProgress(idx, total, 0);
      cancelSpeech(); if(STATE.player.playing) speakNextChunk(); else {
        stopComet(true);
        const w=$(`#sec-overview .w[data-index="${idx}"]`);
        if(w){ w.scrollIntoView({block:"center", behavior:STATE.reduced?'auto':'smooth'}); }
      }
    }

    /* Read state */
    function toggleRead(chapterIndex, checked, silent){
      STATE.readState[chapterIndex] = !!checked; store.set("mia.read", STATE.readState);
      const card = gridEl.querySelector(`.card[data-index="${chapterIndex}"]`);
      if(card){
        card.classList.toggle("read", !!checked);
        const chk = card.querySelector(".readChk");
        if(chk) chk.setAttribute("aria-checked", checked ? "true":"false");
      }
      if(STATE.displayedChapter===chapterIndex){ updateReaderReadToggle(chapterIndex); }
      if(!silent){
        dockEl.setAttribute("aria-live","polite");
        dockEl.setAttribute("aria-label", checked ? "Marked as read" : "Marked as unread");
      }
    }
    function updateReaderReadToggle(chapterIndex){
      const isRead = !!STATE.readState[chapterIndex];
      btnReadToggle.setAttribute("aria-checked", isRead ? "true":"false");
      btnReadToggle.textContent = isRead ? "Read ✓" : "Read";
    }

    /* Orientation / scroll follow */
    function reevaluateTitleOverflow(){ updateDockTitle(); }
    addEventListener("resize", reevaluateTitleOverflow);
    addEventListener("orientationchange", reevaluateTitleOverflow);
    function isWordInView(){
      if(readerEl.style.display!=="block") return false;
      const idx = STATE.player.wordIndex;
      const w = $(`#sec-overview .w[data-index="${idx}"]`);
      if(!w) return false;
      const r = w.getBoundingClientRect();
      const vh = innerHeight;
      return (r.top >= 80 && r.bottom <= vh - 60);
    }
    viewportEl.addEventListener("scroll", ()=>{
      if(STATE.player.follow && !isWordInView()){
        STATE.player.follow=false; setFollowUI(false,true); store.set("mia.player", STATE.player);
      }
    }, {passive:true});

    /* Init */
    function init(){
      try { popEl.hidden = true; menuEl.classList.remove("open"); } catch{}
      STATE.chapters = buildChaptersFromAuthored();
      renderGrid();
      setFollowUI(!!STATE.player.follow, false);
      if(STATE.player.playing){ STATE.player.playing=false; store.set("mia.player", STATE.player); }
      setDockVisible(false);
      document.body.setAttribute("role","application");
      document.addEventListener('visibilitychange', ()=>{ if(document.hidden){ if(STATE.player.playing) pausePlayback(); } });
    }
    window.addEventListener("load", async ()=>{
      init(); await ensureVoices();
      if(!('speechSynthesis' in window)){ btnPlay.disabled=btnPrev.disabled=btnNext.disabled=true; btnPlay.setAttribute("aria-label","Narration not available"); }
    });

  })();
  </script>

<!-- Premium Voice Module v1 (Provider-ready + Customisable) -->
<style>
  /* Minimal modal panel */
  .pv-backdrop{
    position:fixed; inset:0; background:rgba(0,0,0,.45);
    display:none; align-items:center; justify-content:center; z-index:2147483000;
  }
  .pv-modal{
    width:min(560px, 92vw); background:var(--surface, #151826); color:var(--text, #eef3ff);
    border:1px solid var(--stroke, rgba(255,255,255,.18)); border-radius:14px; padding:1rem;
    box-shadow:0 10px 30px rgba(0,0,0,.5);
  }
  .pv-row{ display:flex; gap:.6rem; align-items:center; margin:.5rem 0; }
  .pv-row label{ width:140px; color:var(--muted, #b8c0d8); font-size:.95rem; }
  .pv-row input, .pv-row select{
    flex:1; background:var(--bg1, #141722); color:var(--text,#eef3ff); border:1px solid var(--stroke, rgba(255,255,255,.18));
    border-radius:10px; padding:.5rem .6rem; font: inherit;
  }
  .pv-actions{ display:flex; justify-content:space-between; gap:.6rem; margin-top:.8rem; }
  .pv-actions button{
    padding:.6rem .9rem; border-radius:10px; border:1px solid var(--stroke, rgba(255,255,255,.18));
    background:var(--bg1,#141722); color:var(--text,#eef3ff); font:inherit; cursor:pointer;
  }
  .nat-inline { pointer-events:auto; }
</style>
<script>
(function(){
  if (window.__premium_voice_v1__) return;
  window.__premium_voice_v1__ = true;

  function safe(fn){ try{ return fn(); }catch(e){ return undefined; } }
  function qs(s){ return document.querySelector(s); }
  function qsa(s){ return Array.from(document.querySelectorAll(s)); }

  // --- UI: add Naturalist button (if not present) and premium panel ---
  function ensureNaturalistButton(){
    var btn = document.getElementById('natPreset');
    if (btn) return btn;
    btn = document.createElement('button');
    btn.id = 'natPreset';
    btn.textContent = '🎙 Naturalist';
    btn.className = 'nat-inline';
    btn.style.marginLeft = '.5rem';
    // Try to place near headphone or play button in same toolbar
    var headphone = (qsa('button, [role="button"]')||[]).find(b=>/🎧|headphone|phones/i.test((b.textContent||'')+(b.id||'')+(b.title||'')));
    if (headphone && headphone.parentNode){ headphone.parentNode.insertBefore(btn, headphone.nextSibling); }
    else{
      var bar = qs('header .bar') || qs('.toolbar') || qs('header');
      (bar||document.body).appendChild(btn);
    }
    return btn;
  }

  function buildPanel(){
    var back = document.createElement('div'); back.className = 'pv-backdrop'; back.id = 'pvBackdrop';
    back.innerHTML = `
      <div class="pv-modal" role="dialog" aria-modal="true" aria-labelledby="pvTitle">
        <h3 id="pvTitle" style="margin:.2rem 0 .6rem">Premium Narrator</h3>
        <div class="pv-row"><label>Use Premium</label>
          <select id="pvEnable"><option value="off">Off</option><option value="on">On</option></select>
        </div>
        <div class="pv-row"><label>Provider</label>
          <select id="pvProvider">
            <option value="azure">Azure (Cognitive Services)</option>
            <option value="polly">Amazon Polly</option>
            <option value="elevenlabs">ElevenLabs</option>
            <option value="custom">Custom</option>
          </select>
        </div>
        <div class="pv-row"><label>Voice</label>
          <input id="pvVoice" placeholder="e.g., en-GB-RyanNeural / Brian / Daniel" />
        </div>
        <div class="pv-row"><label>Style</label>
          <input id="pvStyle" placeholder="e.g., narrational, news, calm (provider-specific)" />
        </div>
        <div class="pv-row"><label>Rate</label>
          <input id="pvRate" type="number" step="0.05" min="0.5" max="2" value="0.90" />
        </div>
        <div class="pv-row"><label>Pitch</label>
          <input id="pvPitch" type="number" step="0.05" min="0.5" max="2" value="0.90" />
        </div>
        <div class="pv-row"><label>Proxy URL</label>
          <input id="pvProxy" placeholder="https://your-domain.com/tts" />
        </div>
        <div class="pv-actions">
          <button id="pvTest">Test Voice</button>
          <div>
            <button id="pvSave">Save</button>
            <button id="pvClose">Close</button>
          </div>
        </div>
      </div>`;
    document.body.appendChild(back);
    return back;
  }

  function storeGet(){ try{ return JSON.parse(localStorage.getItem('pv_cfg')||'{}'); }catch(e){ return {}; } }
  function storeSet(cfg){ try{ localStorage.setItem('pv_cfg', JSON.stringify(cfg)); }catch(e){} }

  function showPanel(){
    var back = qs('#pvBackdrop') || buildPanel();
    var cfg = storeGet();
    qs('#pvEnable').value = cfg.enable || 'off';
    qs('#pvProvider').value = cfg.provider || 'azure';
    qs('#pvVoice').value = cfg.voice || 'en-GB-RyanNeural';
    qs('#pvStyle').value = cfg.style || 'narration-professional';
    qs('#pvRate').value = cfg.rate || 0.90;
    qs('#pvPitch').value = cfg.pitch || 0.90;
    qs('#pvProxy').value = cfg.proxy || '';
    back.style.display = 'flex';
  }
  function hidePanel(){ var b = qs('#pvBackdrop'); if (b) b.style.display = 'none'; }

  function wirePanel(){
    var b = qs('#pvBackdrop'); if (!b) return;
    b.addEventListener('click', function(e){ if(e.target === b) hidePanel(); });
    qs('#pvClose').addEventListener('click', hidePanel);
    qs('#pvSave').addEventListener('click', function(){
      var cfg = {
        enable: qs('#pvEnable').value,
        provider: qs('#pvProvider').value,
        voice: qs('#pvVoice').value.trim(),
        style: qs('#pvStyle').value.trim(),
        rate: parseFloat(qs('#pvRate').value)||0.90,
        pitch: parseFloat(qs('#pvPitch').value)||0.90,
        proxy: qs('#pvProxy').value.trim()
      };
      storeSet(cfg);
      hidePanel();
    });
    qs('#pvTest').addEventListener('click', async function(){
      await premiumSpeak('This is a premium narrator test. If you can hear me, your setup works.');
    });
  }

  // ---- Premium synthesis via proxy ----
  async function callProxySynthesize(text){
    var cfg = storeGet();
    if (!cfg.proxy) throw new Error('Proxy URL not set');
    var body = {
      text, provider: cfg.provider||'azure',
      voice: cfg.voice||'en-GB-RyanNeural',
      style: cfg.style||'narration-professional',
      rate: cfg.rate||0.90,
      pitch: cfg.pitch||0.90
    };
    var res = await fetch(cfg.proxy, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(body)
    });
    if(!res.ok) throw new Error('Proxy error: '+res.status);
    // Expect audio/mpeg or audio/ogg
    var blob = await res.blob();
    return URL.createObjectURL(blob);
  }

  const audio = new Audio();
  const q = [];
  let playing = false;

  function enqueue(src){
    q.push(src);
    if(!playing) playNext();
  }
  function playNext(){
    if(!q.length){ playing=false; return; }
    playing = true;
    var src = q.shift();
    audio.src = src;
    audio.onended = function(){ URL.revokeObjectURL(src); playing=false; playNext(); };
    audio.onerror = function(){ playing=false; playNext(); };
    audio.play().catch(()=>{ playing=false; });
  }

  async function premiumSpeak(text){
    var cfg = storeGet();
    if ((cfg.enable||'off') !== 'on') throw new Error('Premium disabled');
    var chunks = chunkText(text, 2500);
    for (const c of chunks){
      const url = await callProxySynthesize(c);
      enqueue(url);
    }
  }

  function chunkText(s, max){
    var out = [], cur='';
    var parts = s.split(/(\. |\? |\! |
)/);
    for (var i=0;i<parts.length;i++){
      var piece = parts[i];
      if ((cur + piece).length > max){
        if (cur) out.push(cur);
        cur = piece.trim();
      } else {
        cur += piece;
      }
    }
    if (cur) out.push(cur);
    return out;
  }

  // ---- Fallback to Web Speech if premium fails ----
  async function tryPremiumOrFallback(text){
    try{
      var cfg = storeGet();
      if ((cfg.enable||'off') === 'on'){
        await premiumSpeak(text);
        return true;
      }
    }catch(e){
      console.warn('Premium failed, falling back to Web Speech:', e);
    }
    return false;
  }

  // Hook your existing Play flow: replace current sentence speak if you expose a global function
  // Otherwise you can manually call tryPremiumOrFallback with the full text.
  // For convenience, we observe clicks on #natPreset to open panel (tap-hold to quick apply).
  function attachButton(){
    var btn = ensureNaturalistButton();
    btn.addEventListener('click', function(e){
      e.preventDefault(); showPanel(); wirePanel();
    });
    // Long-press to quickly force premium reading of current article (if enabled)
    let t; btn.addEventListener('touchstart', ()=>{ t=setTimeout(()=>{ quickPremiumRead(); }, 550); }, {passive:true});
    ['touchend','touchcancel','mouseout','mouseup'].forEach(ev=> btn.addEventListener(ev, ()=>{ clearTimeout(t); }));
  }

  // Example quick premium read: read the visible <article id="content"> text
  async function quickPremiumRead(){
    var el = qs('#content') || document.body;
    var text = (el.innerText||'').trim();
    if (!text) return;
    var used = await tryPremiumOrFallback(text);
    if (!used){
      // If premium is off, do nothing—your existing TTS handles it
    }
  }

  function onReady(){
    attachButton();
    // Auto-load panel with defaults if not set
    var cfg = storeGet();
    if (!cfg.voice){ storeSet({enable:'off', provider:'azure', voice:'en-GB-RyanNeural', style:'narration-professional', rate:0.90, pitch:0.90, proxy:''}); }
  }

  if (document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', onReady, {once:true});
  } else { onReady(); }
})();
</script>

</body>
</html>
